<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Visor PDF</title>
    <link rel="stylesheet" href="../build/pdf_viewer.css" />
    <style>
      :root { color-scheme: light dark; }
      html, body { height: 100%; margin: 0; }
      /* contenedor ocupa todo el alto del iframe */
      #viewerContainer {
        position: relative;
        height: 100dvh;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        background: var(--pdfjs-viewer-bg, #f6f7f9);
      }
      .toolbar {
        position: sticky;
        top: 0;
        display: flex;
        gap: .5rem;
        align-items: center;
        padding: .5rem .75rem;
        border-bottom: 1px solid rgba(0,0,0,.06);
        background: color-mix(in oklab, Canvas 92%, transparent);
        backdrop-filter: blur(6px);
        z-index: 10;
      }
      .toolbar input[type="search"] { flex: 1; }
      .pdfViewer { padding: 1rem; }
      button, input, select { font: inherit; }
    </style>
  </head>
  <body>
    <div class="toolbar">
      <button id="zoomOut" title="Zoom -">−</button>
      <span id="scaleLabel">100%</span>
      <button id="zoomIn" title="Zoom +">+</button>
      <span style="width:.5rem"></span>
      <input id="find" type="search" placeholder="Buscar…" />
      <span style="margin-left:auto"></span>
      <select id="scale">
        <option value="auto">Ajuste automático</option>
        <option value="page-width" selected>Ancho de página</option>
        <option value="page-fit">Ajustar página</option>
        <option value="1.0">100%</option>
        <option value="1.25">125%</option>
        <option value="1.5">150%</option>
        <option value="2.0">200%</option>
      </select>
    </div>

    <div id="viewerContainer">
      <div id="viewer" class="pdfViewer"></div>
    </div>

    <script type="module">
      import * as pdfjsLib from "../build/pdf.mjs";
      import * as pdfjsViewer from "../build/pdf_viewer.mjs";

      // Worker local
      pdfjsLib.GlobalWorkerOptions.workerSrc = "../build/pdf.worker.mjs";

      // Parámetro ?file= (URL ya firmada S3)
      const params = new URLSearchParams(location.search);
      const fileUrl = params.get("file");
      if (!fileUrl) {
        document.getElementById("viewer").innerHTML =
          "<p style='padding:16px;color:#777'>Sin archivo.</p>";
        throw new Error("Missing ?file param");
      }

      const eventBus = new pdfjsViewer.EventBus();
      const linkService = new pdfjsViewer.PDFLinkService({ eventBus });
      const findController = new pdfjsViewer.PDFFindController({
        eventBus,
        linkService,
      });

      const container = document.getElementById("viewerContainer");
      const viewer = new pdfjsViewer.PDFViewer({
        container,
        eventBus,
        linkService,
        findController,
      });
      linkService.setViewer(viewer);

      eventBus.on("pagesinit", () => {
        viewer.currentScaleValue = "page-width";
      });

      // Controles básicos
      const scaleEl = document.getElementById("scale");
      const scaleLabel = document.getElementById("scaleLabel");
      const zoomIn = document.getElementById("zoomIn");
      const zoomOut = document.getElementById("zoomOut");
      const findEl = document.getElementById("find");

      const updateScaleLabel = () => {
        scaleLabel.textContent = `${Math.round(viewer.currentScale * 100)}%`;
      };

      zoomIn.addEventListener("click", () => {
        viewer.currentScale = viewer.currentScale * 1.1;
        updateScaleLabel();
      });
      zoomOut.addEventListener("click", () => {
        viewer.currentScale = viewer.currentScale / 1.1;
        updateScaleLabel();
      });
      scaleEl.addEventListener("change", () => {
        viewer.currentScaleValue = scaleEl.value;
        updateScaleLabel();
      });
      findEl.addEventListener("input", () => {
        eventBus.dispatch("find", {
          type: "",
          query: findEl.value,
          caseSensitive: false,
          entireWord: false,
          highlightAll: true,
          phraseSearch: true,
          findPrevious: false,
        });
      });

      const loadingTask = pdfjsLib.getDocument(fileUrl);
      const pdf = await loadingTask.promise;
      viewer.setDocument(pdf);
      linkService.setDocument(pdf);
    </script>
  </body>
</html>
